# BOM #2: Beacons

A Moneysocket beacon specifies the means by which two applications, a Provider and a Consumer, are to form a socket connection. Ths information is encoded into a string and is to be generated by one application and shared to the other.


## Generator

The application that generates the beacon is referred to as the generator. The generator application can be of either Consumer, Provider or Automatic role. By generating the beacon, the application is seeking a compatible counterpart application to rendezvous.

## Bech32 encoding

Beacon strings are encoded in Bech32 format as specified by [BIP #0174](https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki)

### Human Readable Prefix

- MUST start prefix with `moneysocket`
- MAY specify additional user hints in the HRP. up to the permitted 83 US-ASCII characters. E.g `moneysocket-paste-wallet`, `moneysocket-paste-application`.
- MUST use lowercase alphabetic characters.


### Data Part

Data part is encoded as a TLV which contains a tlv stream:

The data part:

- MUST have only one TLV, which is the tlv\_stream (tlv wrapper specifies length)

The tlv stream:
    - MUST include a Generator Version TLV
    - SHOULD include a Role Hint TLV
    - MUST include a Shared Seed TLV
    - MUST include a Location List TLV
    - MAY include additional TLVs to pass non-standard data
        - SHOULD pick custom record `type` value following rules in [BOLT #01](https://github.com/lightningnetwork/lightning-rfc/blob/master/01-messaging.md#type-length-value-format).

1. type: 0 (`beacon`)
2. data:
    * [`tlv_stream`: `beacon_tlvs`]


#### Generator Version TLV

Specifies the version of application which generated this beacon.

- MUST set `major` version of the Moneysocket protocol of the generator application
- SHOULD set `minor` version of the generator application software release, otherwise set 0.
- SHOULD set `patch` version of the generator application software release, otherwise set 0.

1. type: 0 (`version`)
2. data:
    * [`u8`: `major`]
    * [`u8`: `minor`]
    * [`u8`: `patch`]

#### Role Hint TLV

Specifies a byte-sized enumeration value set by the generating application to indicate the role of the sought counterpart.

- `PROVIDER_GENERATOR_SEEKING_CONSUMER`: `hint` = `0x00`
- `CONSUMER_GENERATOR_SEEKING_PROVIDER`: `hint` = `0x01`
- `AUTOMATIC_GENERATOR`: `hint` = `0x02`
- All other values are reserved.

1. type: 1 (`role_hint`)
2. data:
    * [`u8`: `hint`]


#### Shared Seed TLV

A secret value that to be known to both applications seeking connection, passed via this beacon.

- MUST be a cryptographic-strength, randomly-generated 128-bit value
- MUST NOT re-use this value for other beacons
- MUST interpret `hi` and `lo` 64-bit value as a big endian 128-bit value with `hi` taken as as higher-order bytes and `lo` taken as lower-order bytes.

1. type: 2 (`shared_seed`)
2. data:
    * [`u64`: `hi`]
    * [`u64`: `lo`]


#### Location List TLV

Specifies a list of locations for rendezvous for the generator and sought counterpart.

- MUST include at least one Location TLV
- MAY have more than one Location TLV type
- MAY have more than one Location TLV of the same type

1. type: 3 (`shared_seed`)
2. data:
    * [`tlv_stream`: `location_tlvs`]


##### Websocket Location TLV

Specifies a location for a WebSocket connection rendezvous.

- MAY include a Generator Preference TLV to rank the Generator's preference for this location compared to others in the Location List TLV. If it is not included, it will imply a preference ranking of 255.
- MUST include a Hostname TLV to specify the DNS hostname of the WebSocket rendezvous location.
    - MUST be a valid hostname
- MAY include a TLS TLV to specify whether the connection should use TLS. If it is not included, it will imply a setting of `true` to indicate TLS is to be used.
- MAY include a Port TLV to specify a custom port for the WebSocket connection. If it is not included, it will imply a value of `443` for TLS connections and `80` for non-TLS connections.
- MAY include a Path TLV to specify a custom path for the WebSocket connection URL. If it is not included, it will imply a connection to the root (`/`) URL path.

1. type: 0 (`WebSocket_location`)
2. data:
    * [`tlv_stream`: `tlvs`]


###### Generator Preference TLV

An optional value chosen by the generator that indicates it's relative preference for connection locations among the location list for the sought counterpart to rendezvous via. A value of `0` indicates highest preference and a value of `255` indicates lowest preference.

1. type: 0 (`generator_preference`)
2. data:
    * [`u8`: `preference`]

###### Hostname TLV

A DNS hostname for where the WebSocket connection request are to be sent.

1. type: 1 (`hostname`)
2. data:
    * [`len*byte`: `hostname`]

###### TLS TLV

An enum value that specifies whether TLS should be used for the WebSocket connection.

- `TLS_FALSE`: `tls` = `0x00`
- `TLS_TRUE`: `tls` = `0x01`
- All other values are reserved.

1. type: 2 (`tls`)
2. data:
    * [`u8`: `tls`]

###### Port TLV

An unsigned integer value for which port number to use for the WebSocket connection.

1. type: 3 (`port`)
2. data:
    * [`bigsize`: `port`]

###### Path TLV

A pathname for the WebSocket url connection.

- MAY include one or more leading `/` characters which will be ignored.

1. type: 4 (`path`)
2. data:
    * [`len*byte`: `path`]


## Beacons passed via QR Codes

### QR Code Encoding

- SHOULD pre-format beacons to use only characters from Alphanumeric character codes. i.e `[0-9]`, `[A-Z]`, `$`, `%`, `*`, `+`, `-`, `.`, `/`, and `:`.
     - (note, ASCII Space, aka `0x20`, is not allowed in bech32 strings, though considerd alphanumeric for QR codes)
    - Convert all alphabetic characters to uppercase
    - if a character is non-alphanumeric:
        - if a character is `$`, `%`, `*`, `+`, `-`, `.`, `/`, and `:`:
            - encode to QR as-is
        - if a character is not `$`, `%`, `*`, `+`, `-`, `.`, `/`, and `:`:
            - encode to QR as `.`

### QR Code Decoding

- MUST reject all QR-code-decoded strings that do not start with `moneysocket` or `MONEYSOCKET` (or any mixed case).
- MUST convert QR-code-decoded strings with the prefix `MONEYSOCKET` to `moneysocket`
- SHOULD covert all alphabetic characters to lowercase.
- SHOULD evaluate the bech32 checksum of the data part immediately after decoding from QR code to ensure full integrity.



## Appendix A - Test Vectors

TODO
